<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת לניהול שיעורים ותשלומים</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; direction: rtl; background-color: #f4f4f4; color: #333;}
        h1, h2 { text-align: center; color: #0056b3; border-bottom: 2px solid #0056b3; padding-bottom: 5px; margin-bottom: 20px;}
        .container { max-width: 1200px; margin: auto; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background-color: #fff; }
        .section { margin-bottom: 30px; padding: 15px; border: 1px solid #eee; border-radius: 6px; }
        button { padding: 10px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 5px; margin-left: 10px;}
        button:hover { background-color: #45a049; }
        .error { color: red; font-weight: bold; text-align: center; margin-top: 10px; }
        .success { color: green; font-weight: bold; text-align: center; margin-top: 10px; }
        .summary-box { border: 2px solid #333; padding: 15px; margin-top: 20px; background-color: #f9f9f9; border-radius: 6px; }

        /* --- סטיילינג לוח שנה (דרישה 2) --- */
        #calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr); /* 7 עמודות לימי השבוע */
            gap: 5px;
            border: 1px solid #ccc;
            padding: 5px;
            direction: rtl; 
            margin-top: 15px;
        }
        .day-header {
            background-color: #e6f7ff;
            font-weight: bold;
            text-align: center;
            padding: 8px;
            border: 1px solid #b3e0ff;
        }
        .day-cell {
            background-color: #fff;
            border: 1px solid #ddd;
            min-height: 150px;
            padding: 5px;
            position: relative;
        }
        .date-label {
            font-weight: bold;
            color: #007bff;
            font-size: 1.1em;
            margin-bottom: 5px;
            padding-bottom: 3px;
            border-bottom: 1px solid #eee;
            display: block;
        }
        .lesson-entry {
            margin-top: 3px;
            padding: 5px;
            background-color: #f0f0f0;
            border-radius: 3px;
            font-size: 0.9em;
            cursor: pointer;
            border-right: 4px solid #aaa;
            line-height: 1.3;
        }
        .lesson-entry strong { font-size: 1.1em; }

        .paid { border-right-color: #28a745; background-color: #d4edda; }
        .unpaid { border-right-color: #dc3545; background-color: #f8d7da; }
        .pending { border-right-color: #ffc107; background-color: #fff3cd; }

        /* --- סטיילינג תלמידים חסרים (דרישה 3) --- */
        #no-lessons-box {
            margin-top: 30px;
            padding: 15px;
            background-color: #fcf8e3;
            border: 1px solid #faebcc;
            color: #8a6d3b;
            border-radius: 6px;
        }
        #no-lessons-list {
            list-style: none;
            padding: 0;
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
        }
        #no-lessons-list li {
            background-color: #f2dd73;
            padding: 5px 10px;
            margin-left: 10px;
            margin-bottom: 5px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        /* הסתרת טבלת האירועים הישנה */
        #eventsTable { display: none; } 
    </style>
</head>
<body>

<div class="container">
    <h1>מערכת ניהול יומן ותשלומים לתלמידים</h1>

    <div class="section">
        <h2>שלב 1: חיבור ל-Google Calendar</h2>
        <p>חובה לבצע חיבור ואשרור כדי לאפשר שליפת נתונים.</p>
        <button onclick="location.href='/api/auth/google'">התחבר ל-Google Calendar</button>
    </div>

    <div class="section">
        <h2>שלב 2: ניהול תלמידים ומחירי שיעור</h2>
        <p>עדכן את שמות התלמידים, תדירות השיעור והמחיר לשיעור. לחץ 'שמור' בסיום.</p>
        <table id="studentsTable">
            <thead>
                <tr>
                    <th>שם התלמיד</th>
                    <th>תדירות (שבועי/דו-שבועי)</th>
                    <th>מחיר שיעור (₪)</th>
                    <th>פעולה</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button onclick="addStudent()">הוסף תלמיד</button>
        <button onclick="saveStudents()">שמור שינויים ל-GitHub</button>
        <div id="studentMessage" class="message"></div>
    </div>

    <div class="section">
        <h2>שלב 3: תצוגת אירועי יומן וסטטוס תשלום</h2>
        <button onclick="loadCalendarEvents()">טען אירועי יומן לשבועיים הקרובים</button>
        <div id="eventMessage" class="message"></div>
        
        <div id="calendar-grid-container">
            <div id="calendar-grid">
                </div>
        </div>
        
        <div id="no-lessons-box" style="display: none;">
            <h3>⚠️ תלמידים ללא שיעור בטווח הנבדק</h3>
            <ul id="no-lessons-list"></ul>
        </div>

        <table id="eventsTable">
            <thead>
                <tr>
                    <th>תאריך ושעה</th>
                    <th>תלמיד</th>
                    <th>מחיר (₪)</th>
                    <th>סטטוס תשלום</th>
                    <th>פעולה</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div id="paymentSummary" class="summary-box" style="display: none;">
            <h3>סיכום תשלומים שהתקבלו</h3>
        </div>
    </div>
</div>

<div id="paymentModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 1000;">
    <div style="background: white; padding: 30px; border-radius: 8px; width: 350px; text-align: right;">
        <h3 id="modalLessonName" style="text-align: center;"></h3>
        <p style="margin-top: 15px;">בחר סטטוס תשלום:</p>
        <select id="paymentStatusSelect" style="width: 100%; padding: 10px; margin-bottom: 20px;">
            <option value="לא בוצע עדיין">--- (לא בוצע עדיין)</option>
            <option value="שולם">שולם</option>
            <option value="לא שולם">לא שולם</option>
            <option value="ממתין">ממתין</option>
        </select>
        <button onclick="savePaymentStatus()" style="background-color: #007bff;">שמור</button>
        <button onclick="closePaymentModal()" style="background-color: #dc3545;">בטל</button>
    </div>
</div>

<script>
    const STUDENTS_DEFAULT_PRICE = 170;
    let students = [];
    let studentsMap = {}; 
    let currentLessonKey = null; 

    document.addEventListener('DOMContentLoaded', loadStudents);

    // --- פונקציות ניהול תלמידים (ללא שינוי מהקובץ המקורי שלך) ---

    async function loadStudents() {
        try {
            const response = await fetch('/api/students');
            if (!response.ok) throw new Error('Failed to load students list.');
            students = await response.json();
            
            // יצירת מפה נוחה לשימוש מהיר בהצגת אירועים (מטפל במקרה של רווחים או אותיות קטנות/גדולות)
            studentsMap = students.reduce((map, s) => {
                const fullNameClean = s.name.trim().toLowerCase();
                map[fullNameClean] = { 
                    price: s.price || STUDENTS_DEFAULT_PRICE, 
                    name: s.name // שם מקורי
                };

                // מוסיף גם שם פרטי אם שונה מהשם המלא
                const firstName = s.name.split(' ')[0].trim().toLowerCase();
                 if (firstName && firstName !== fullNameClean) {
                    // חשוב: לא דורס אם שם פרטי של אחד זהה לשם מלא של אחר
                    if (!map[firstName]) {
                        map[firstName] = { 
                            price: s.price || STUDENTS_DEFAULT_PRICE, 
                            name: s.name // שם מקורי
                        };
                    }
                }

                return map;
            }, {});

            renderStudentsTable();
        } catch (error) {
            console.error('Error loading students:', error);
            document.getElementById('studentMessage').className = 'error';
            document.getElementById('studentMessage').textContent = `שגיאה בטעינת תלמידים: ${error.message}`;
        }
    }

    function renderStudentsTable() {
        const tableBody = document.querySelector('#studentsTable tbody');
        tableBody.innerHTML = '';

        students.forEach((student, index) => {
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td><input type="text" value="${student.name}" onchange="updateStudent(event, ${index}, 'name')"></td>
                <td>
                    <select onchange="updateStudent(event, ${index}, 'frequency')">
                        <option value="weekly" ${student.frequency === 'weekly' ? 'selected' : ''}>שבועי</option>
                        <option value="biweekly" ${student.frequency === 'biweekly' ? 'selected' : ''}>דו-שבועי</option>
                    </select>
                </td>
                <td><input type="number" value="${student.price || STUDENTS_DEFAULT_PRICE}" onchange="updateStudent(event, ${index}, 'price')"></td>
                <td><button onclick="deleteStudent(${index})">מחק</button></td>
            `;
        });
    }

    function updateStudent(event, index, key) {
        let value = event.target.value;
        if (key === 'price') {
            value = parseInt(value) || STUDENTS_DEFAULT_PRICE;
        }
        students[index][key] = value;
    }

    function deleteStudent(index) {
        students.splice(index, 1);
        renderStudentsTable();
    }

    async function saveStudents() {
        try {
            const response = await fetch('/api/students/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ students: students })
            });

            const result = await response.json();
            const messageElement = document.getElementById('studentMessage');
            
            if (response.ok) {
                messageElement.className = 'success';
                messageElement.innerHTML = `${result.message} (<a href="${result.commit_url}" target="_blank">צפה ב-Commit</a>)`;
                loadStudents(); 
            } else {
                throw new Error(result.error || 'שגיאה בשמירה ל-GitHub.');
            }
        } catch (error) {
            console.error('Error saving students:', error);
            document.getElementById('studentMessage').className = 'error';
            document.getElementById('studentMessage').textContent = `שגיאה בשמירה: ${error.message}`;
        }
    }

    // --- פונקציות יומן ותשלומים (מתוקנות) ---

    async function loadCalendarEvents() {
        document.getElementById('eventMessage').textContent = 'טוען אירועי יומן...';
        document.getElementById('calendar-grid').innerHTML = ''; 
        document.getElementById('no-lessons-box').style.display = 'none';
        document.getElementById('paymentSummary').style.display = 'none';
        
        try {
            const response = await fetch('/api/calendar/events');
            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || 'שגיאה בשליפת יומן.');
            }
            
            // השרת מחזיר כעת אובייקט עם events ו-studentsWithoutLessons
            renderCalendarGrid(result.events, result.startDate); 
            renderStudentsWithoutLessons(result.studentsWithoutLessons); 
            
            document.getElementById('eventMessage').className = 'success';
            document.getElementById('eventMessage').textContent = `✅ נטענו ${result.events.length} אירועי יומן.`;
        } catch (error) {
            console.error('Error loading events:', error);
            document.getElementById('eventMessage').className = 'error';
            document.getElementById('eventMessage').textContent = `שגיאה בטעינת יומן: ${error.message}. אנא וודא שהתחברת ליומן בשלב 1.`;
        }
    }

    // פונקציה לבניית תצוגת לוח השנה המרובעת (דרישה 2)
    function renderCalendarGrid(events, startDateIso) {
        const calendarGrid = document.getElementById('calendar-grid');
        calendarGrid.innerHTML = '';
        const dayNames = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת'];
        const daysMap = new Map();
        
        // 1. יצירת כותרות הימים
        dayNames.forEach(name => {
            const header = document.createElement('div');
            header.classList.add('day-header');
            header.textContent = name;
            calendarGrid.appendChild(header);
        });

        // 2. הכנת המפה ל-14 הימים (מתחילים מה-startDate שחזר מהשרת)
        const startDate = new Date(startDateIso);
        for (let i = 0; i < 14; i++) {
            const date = new Date(startDate.getTime() + (i * 24 * 60 * 60 * 1000));
            const dateKey = date.toISOString().split('T')[0];
            daysMap.set(dateKey, { date: date, events: [] });
        }

        // 3. מיון האירועים לתוך המפה
        events.forEach(event => {
            const dateKey = event.start.dateTime.split('T')[0];
            if (daysMap.has(dateKey)) {
                daysMap.get(dateKey).events.push(event);
            }
        });
        
        // 4. בניית ריבועי לוח השנה
        daysMap.forEach((dayData, dateKey) => {
            const cell = document.createElement('div');
            cell.classList.add('day-cell');
            
            // תאריך
            const dateHeader = document.createElement('span');
            dateHeader.classList.add('date-label');
            dateHeader.textContent = dayData.date.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit' });
            cell.appendChild(dateHeader);
            
            // מיון האירועים לפי שעה
            dayData.events.sort((a, b) => new Date(a.start.dateTime) - new Date(b.start.dateTime));

            // הוספת השיעורים לריבוע
            dayData.events.forEach(event => {
                const lessonEntry = document.createElement('div');
                lessonEntry.classList.add('lesson-entry');
                
                const eventStart = new Date(event.start.dateTime);
                const time = eventStart.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
                
                // דרישה 2: פשוט: 15:00 זיו רז
                lessonEntry.innerHTML = `<strong>${time}</strong> ${event.summary.trim()}`;
                
                // סטטוס תשלום
                const status = event.paymentStatus || 'לא בוצע עדיין';
                if (status === 'שולם') {
                    lessonEntry.classList.add('paid');
                } else if (status === 'לא שולם') {
                    lessonEntry.classList.add('unpaid');
                } else if (status === 'ממתין') {
                    lessonEntry.classList.add('pending');
                }

                lessonEntry.onclick = () => openPaymentModal(event);
                cell.appendChild(lessonEntry);
            });
            
            calendarGrid.appendChild(cell);
        });
        
        renderPaymentSummary(events);
    }
    
    // פונקציה להצגת תלמידים שלא קבעו שיעור (דרישה 3)
    function renderStudentsWithoutLessons(studentsList) {
        const noLessonsBox = document.getElementById('no-lessons-box');
        const noLessonsList = document.getElementById('no-lessons-list');
        noLessonsList.innerHTML = '';
        
        if (studentsList && studentsList.length > 0) {
            noLessonsBox.style.display = 'block';
            studentsList.forEach(name => {
                const li = document.createElement('li');
                li.textContent = name;
                noLessonsList.appendChild(li);
            });
        } else {
            noLessonsBox.style.display = 'none';
        }
    }

    // --- פונקציות מודאל ותשלום ---

    function openPaymentModal(event) {
        currentLessonKey = event.lessonKey;
        document.getElementById('modalLessonName').textContent = `שיעור: ${event.summary}`;
        document.getElementById('paymentStatusSelect').value = event.paymentStatus || 'לא בוצע עדיין';
        document.getElementById('paymentModal').style.display = 'flex';
    }

    function closePaymentModal() {
        document.getElementById('paymentModal').style.display = 'none';
        currentLessonKey = null;
    }
    
    async function savePaymentStatus() {
        const status = document.getElementById('paymentStatusSelect').value;
        
        try {
            const response = await fetch('/api/payments/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lessonKey: currentLessonKey, status: status })
            });

            if (response.ok) {
                alert('סטטוס תשלום נשמר בהצלחה!');
                closePaymentModal();
                loadCalendarEvents(); // טען מחדש את הנתונים כדי לעדכן את לוח השנה והסיכום
            } else {
                const data = await response.json();
                alert('שגיאה בשמירת תשלום: ' + (data.error || 'שגיאה לא ידועה'));
            }
        } catch (error) {
            alert('שגיאת רשת או שרת בשמירת תשלום.');
        }
    }

    function getStartOfWeek(date) {
        const d = new Date(date);
        // יום ראשון (0) הוא תחילת השבוע (כדי להתאים ללוגיקת השרת)
        const day = d.getDay(); 
        const diff = d.getDate() - day;
        const startOfWeek = new Date(d.setDate(diff));
        startOfWeek.setHours(0, 0, 0, 0);
        return startOfWeek.toISOString().split('T')[0];
    }

    // פונקציה לחישוב וייצוג סיכום התשלומים (כולל התיקון לזיהוי שם התלמיד)
    function renderPaymentSummary(events) {
        const summaryBox = document.getElementById('paymentSummary');
        const paymentSummary = {};

        events.forEach(event => {
            const status = event.paymentStatus || 'לא בוצע עדיין';
            // סופרים רק שיעורים ששולמו
            if (status !== 'שולם') return; 

            // 1. נקיון כותרת האירוע
            const eventSummaryLower = event.summary.trim().toLowerCase();
            let lessonPrice = STUDENTS_DEFAULT_PRICE;

            // 2. מציאת שם התלמיד והמחיר שלו מתוך המפה הקיימת (studentsMap)
            let studentNameCleanMatch = null;

            // עוברים על כל השמות המנוקים (שם מלא או שם פרטי) ומחפשים התאמה בכותרת
            for (const cleanName in studentsMap) {
                if (eventSummaryLower.includes(cleanName)) {
                    studentNameCleanMatch = cleanName;
                    break;
                }
            }

            if (studentNameCleanMatch) {
                lessonPrice = studentsMap[studentNameCleanMatch].price;
            }


            // 3. חישוב שבוע
            const eventStart = new Date(event.start.dateTime || event.start.date);
            const weekStartDate = getStartOfWeek(eventStart);
            
            if (!paymentSummary[weekStartDate]) {
                paymentSummary[weekStartDate] = { received: 0, startDate: eventStart };
            }
            paymentSummary[weekStartDate].received += lessonPrice;
        });

        let html = '<h3>סיכום תשלומים שהתקבלו</h3>';
        
        // מיון לפי תאריך התחלה
        const sortedWeeks = Object.keys(paymentSummary).sort();
        let totalIncome = 0; // משתנה לסיכום כולל

        sortedWeeks.forEach(weekStartIso => {
            const weekData = paymentSummary[weekStartIso];
            totalIncome += weekData.received; // הוספה לסיכום הכולל

            const startOfWeek = new Date(weekStartIso);
            const endOfWeek = new Date(startOfWeek.getTime() + 6 * 24 * 60 * 60 * 1000); 

            const formattedStart = startOfWeek.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit' });
            const formattedEnd = endOfWeek.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit' });

            html += `
                <p><strong>סה"כ תשלום שהתקבל לשבוע ${formattedStart} - ${formattedEnd}:</strong> ₪${weekData.received}</p>
            `;
        });
        
        // הוספת שורת הסיכום הכולל
        if (totalIncome > 0) {
             html += `<hr style="margin: 10px 0;">`;
             html += `<p style="font-size: 1.2em; font-weight: bold; color: #0056b3;">סה"כ הכנסות מתשלומים שאושרו (בטווח הנבדק): ₪${totalIncome}</p>`;
        }


        summaryBox.innerHTML = html;
        summaryBox.style.display = sortedWeeks.length > 0 ? 'block' : 'none';
    }
</script>

</body>
</html>
