<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ×œ× ×™×”×•×œ ×©×™×¢×•×¨×™× ×•×ª×©×œ×•××™×</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; direction: rtl; background-color: #f4f4f4; color: #333;}
        h1, h2 { text-align: center; color: #0056b3; border-bottom: 2px solid #0056b3; padding-bottom: 5px; margin-bottom: 20px;}
        .container { max-width: 1200px; margin: auto; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background-color: #fff; }
        .section { margin-bottom: 30px; padding: 15px; border: 1px solid #eee; border-radius: 6px; }
        button { padding: 10px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 5px; margin-left: 10px;}
        button:hover { background-color: #45a049; }
        .error { color: red; font-weight: bold; text-align: center; margin-top: 10px; }
        .success { color: green; font-weight: bold; text-align: center; margin-top: 10px; }
        .summary-box { border: 2px solid #333; padding: 15px; margin-top: 20px; background-color: #f9f9f9; border-radius: 6px; }

        /* --- ×¡×˜×™×™×œ×™× ×’ ×œ×•×— ×©× ×” --- */
        #calendar-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 10px; 
            padding: 5px 0;
            border-bottom: 1px solid #ccc;
        }
        #current-month-display {
            font-size: 1.5em;
            font-weight: bold;
            color: #0056b3;
            text-align: center;
            flex-grow: 1;
        }
        #calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr); /* 7 ×¢××•×“×•×ª ×œ×™××™ ×”×©×‘×•×¢ */
            gap: 5px;
            border: 1px solid #ccc;
            padding: 5px;
            direction: rtl; 
            margin-top: 15px;
        }
        .day-header {
            background-color: #e6f7ff;
            font-weight: bold;
            text-align: center;
            padding: 8px;
            border: 1px solid #b3e0ff;
        }
        .day-cell {
            background-color: #fff;
            border: 1px solid #ddd;
            min-height: 100px; /* ×”×•×§×˜×Ÿ ×›×“×™ ×œ×”×ª××™× ×œ×ª×¦×•×’×” ×—×•×“×©×™×ª */
            padding: 5px;
            position: relative;
        }
        .date-label {
            font-weight: bold;
            color: #007bff;
            font-size: 1.1em;
            margin-bottom: 5px;
            padding-bottom: 3px;
            border-bottom: 1px solid #eee;
            display: block;
        }
        .lesson-entry {
            margin-top: 3px;
            padding: 5px;
            background-color: #f0f0f0;
            border-radius: 3px;
            font-size: 0.8em; /* ×”×•×§×˜×Ÿ ×›×“×™ ×œ×”×ª××™× ×œ×ª×¦×•×’×” ×—×•×“×©×™×ª */
            cursor: pointer;
            border-right: 4px solid #aaa;
            line-height: 1.2;
        }
        .lesson-entry strong { font-size: 1.0em; }

        .paid { border-right-color: #28a745; background-color: #d4edda; }
        .unpaid { border-right-color: #dc3545; background-color: #f8d7da; }
        .pending { border-right-color: #ffc107; background-color: #fff3cd; }

        /* --- ×¡×˜×™×™×œ×™× ×’ ×ª×œ××™×“×™× ×—×¡×¨×™× --- */
        #no-lessons-box {
            margin-top: 30px;
            padding: 15px;
            background-color: #fcf8e3;
            border: 1px solid #faebcc;
            color: #8a6d3b;
            border-radius: 6px;
        }
        #no-lessons-list {
            list-style: none;
            padding: 0;
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
        }
        #no-lessons-list li {
            background-color: #f2dd73;
            padding: 5px 10px;
            margin-left: 10px;
            margin-bottom: 5px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        /* ×”×¡×ª×¨×ª ×˜×‘×œ×ª ×”××™×¨×•×¢×™× ×”×™×©× ×” */
        #eventsTable { display: none; } 
    </style>
</head>
<body>

<div class="container">
    <h1>××¢×¨×›×ª × ×™×”×•×œ ×™×•××Ÿ ×•×ª×©×œ×•××™× ×œ×ª×œ××™×“×™×</h1>

    <div class="section">
        <h2>×©×œ×‘ 1: ×—×™×‘×•×¨ ×œ-Google Calendar</h2>
        <p>×—×•×‘×” ×œ×‘×¦×¢ ×—×™×‘×•×¨ ×•××©×¨×•×¨ ×›×“×™ ×œ××¤×©×¨ ×©×œ×™×¤×ª × ×ª×•× ×™×.</p>
        <button onclick="location.href='/api/auth/google'">×”×ª×—×‘×¨ ×œ-Google Calendar</button>
    </div>

    <div class="section">
        <h2>×©×œ×‘ 2: × ×™×”×•×œ ×ª×œ××™×“×™× ×•××—×™×¨×™ ×©×™×¢×•×¨</h2>
        <p>×¢×“×›×Ÿ ××ª ×©××•×ª ×”×ª×œ××™×“×™×, ×ª×“×™×¨×•×ª ×”×©×™×¢×•×¨ ×•×”××—×™×¨ ×œ×©×™×¢×•×¨. ×œ×—×¥ '×©××•×¨' ×‘×¡×™×•×.</p>
        <table id="studentsTable">
            <thead>
                <tr>
                    <th>×©× ×”×ª×œ××™×“</th>
                    <th>×ª×“×™×¨×•×ª (×©×‘×•×¢×™/×“×•-×©×‘×•×¢×™)</th>
                    <th>××—×™×¨ ×©×™×¢×•×¨ (â‚ª)</th>
                    <th>×¤×¢×•×œ×”</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button onclick="addStudent()">×”×•×¡×£ ×ª×œ××™×“</button>
        <button onclick="saveStudents()">×©××•×¨ ×©×™× ×•×™×™× ×œ-GitHub</button>
        <div id="studentMessage" class="message"></div>
    </div>

    <div class="section">
        <h2>×©×œ×‘ 3: ×ª×¦×•×’×ª ××™×¨×•×¢×™ ×™×•××Ÿ ×•×¡×˜×˜×•×¡ ×ª×©×œ×•×</h2>
        <div id="calendar-controls">
            <button onclick="navigateMonth(-1)">â¬…ï¸ ×—×•×“×© ×§×•×“×</button>
            <span id="current-month-label" style="font-weight: bold; margin: 0 15px;"></span>
            <button onclick="navigateMonth(1)">×—×•×“×© ×”×‘× â¡ï¸</button>
            <button onclick="loadCalendarEvents()">×˜×¢×Ÿ ××™×¨×•×¢×™ ×™×•××Ÿ ×œ×—×•×“×© ×”× ×•×›×—×™</button>
        </div>
        <div id="eventMessage" class="message"></div>
        
        <div id="calendar-grid-container">
            <div id="calendar-grid">
                </div>
        </div>
        
        <div id="no-lessons-box" style="display: none;">
            <h3>âš ï¸ ×ª×œ××™×“×™× ×œ×œ× ×©×™×¢×•×¨ ×‘×—×•×“×© ×–×”</h3>
            <ul id="no-lessons-list"></ul>
        </div>

        <div id="paymentSummary" class="summary-box" style="display: none;">
            <h3>×¡×™×›×•× ×ª×©×œ×•××™× ×©×”×ª×§×‘×œ×•</h3>
        </div>
    </div>
</div>

<div id="paymentModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 1000;">
    <div style="background: white; padding: 30px; border-radius: 8px; width: 350px; text-align: right;">
        <h3 id="modalLessonName" style="text-align: center;"></h3>
        <p style="margin-top: 15px;">×‘×—×¨ ×¡×˜×˜×•×¡ ×ª×©×œ×•×:</p>
        <select id="paymentStatusSelect" style="width: 100%; padding: 10px; margin-bottom: 20px;">
            <option value="×œ× ×‘×•×¦×¢ ×¢×“×™×™×Ÿ">--- (×œ× ×‘×•×¦×¢ ×¢×“×™×™×Ÿ)</option>
            <option value="×©×•×œ×">×©×•×œ×</option>
            <option value="×œ× ×©×•×œ×">×œ× ×©×•×œ×</option>
            <option value="×××ª×™×Ÿ">×××ª×™×Ÿ</option>
        </select>
        <button onclick="savePaymentStatus()" style="background-color: #007bff;">×©××•×¨</button>
        <button onclick="closePaymentModal()" style="background-color: #dc3545;">×‘×˜×œ</button>
    </div>
</div>

<script>
    const STUDENTS_DEFAULT_PRICE = 170;
    let students = [];
    let studentsMap = {}; 
    let currentLessonKey = null; 
    
    // ××¦×‘ ×’×œ×•×‘×œ×™ ×œ× ×™×•×•×˜ ×—×•×“×©×™
    let currentMonth; // 0-11
    let currentYear;

    document.addEventListener('DOMContentLoaded', initializeCalendar);
    document.addEventListener('DOMContentLoaded', loadStudents);

    function initializeCalendar() {
        const today = new Date();
        // ×”×’×“×¨×ª ×‘×¨×™×¨×ª ×”××—×“×œ ×œ×—×•×“×© ×”× ×•×›×—×™
        currentMonth = today.getMonth(); 
        currentYear = today.getFullYear();
        updateMonthLabel();
    }
    
    // ××’×‘×™×œ ××ª ×”×˜×•×•×— ×œ×©× ×ª×™×™× ×§×“×™××” ×•×©× ×ª×™×™× ××—×•×¨×” (×¡×”"×› 5 ×©× ×™×)
    function navigateMonth(delta) {
        const newDate = new Date(currentYear, currentMonth + delta, 1);
        
        const minYear = new Date().getFullYear() - 2;
        const maxYear = new Date().getFullYear() + 2;
        
        // ×”×’×‘×œ×ª ×”× ×™×•×•×˜
        if (newDate.getFullYear() < minYear || newDate.getFullYear() > maxYear) {
            alert("×”× ×™×•×•×˜ ××•×’×‘×œ ×œ×©× ×ª×™×™× ×§×“×™××” ×•××—×•×¨×” ××”×©× ×” ×”× ×•×›×—×™×ª.");
            return; 
        }

        currentMonth = newDate.getMonth();
        currentYear = newDate.getFullYear();
        updateMonthLabel();
        loadCalendarEvents();
    }

    function updateMonthLabel() {
        const date = new Date(currentYear, currentMonth, 1);
        const options = { year: 'numeric', month: 'long' };
        document.getElementById('current-month-label').textContent = date.toLocaleDateString('he-IL', options);
    }

    // --- ×¤×•× ×§×¦×™×•×ª × ×™×”×•×œ ×ª×œ××™×“×™× (×œ×œ× ×©×™× ×•×™ ××”×•×ª×™) ---

    async function loadStudents() {
        try {
            const response = await fetch('/api/students');
            if (!response.ok) throw new Error('Failed to load students list.');
            students = await response.json();
            
            // ×™×¦×™×¨×ª ××¤×” × ×•×—×” ×œ×©×™××•×© ××”×™×¨ ×‘×”×¦×’×ª ××™×¨×•×¢×™× 
            studentsMap = students.reduce((map, s) => {
                const originalName = s.name.trim();
                const lowerName = originalName.toLowerCase();

                const nameParts = originalName.split(/\s+/).filter(p => p.length > 1);
                
                map[lowerName] = { price: s.price || STUDENTS_DEFAULT_PRICE, name: originalName }; 
                
                nameParts.forEach(part => {
                    const partLower = part.toLowerCase();
                    if (partLower !== lowerName && !map[partLower]) {
                        map[partLower] = { price: s.price || STUDENTS_DEFAULT_PRICE, name: originalName };
                    }
                });

                return map;
            }, {});

            renderStudentsTable();
            loadCalendarEvents(); // ×˜×¢×Ÿ ×—×•×“×© × ×•×›×—×™ ××•×˜×•××˜×™×ª ×‘×¤×¢× ×”×¨××©×•× ×”
        } catch (error) {
            console.error('Error loading students:', error);
            document.getElementById('studentMessage').className = 'error';
            document.getElementById('studentMessage').textContent = `×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×œ××™×“×™×: ${error.message}`;
        }
    }
    
    function renderStudentsTable() { /* (× ×©××¨ ×›×¤×™ ×©×”×™×”) */
        const tableBody = document.querySelector('#studentsTable tbody');
        tableBody.innerHTML = '';

        students.forEach((student, index) => {
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td><input type="text" value="${student.name}" onchange="updateStudent(event, ${index}, 'name')"></td>
                <td>
                    <select onchange="updateStudent(event, ${index}, 'frequency')">
                        <option value="weekly" ${student.frequency === 'weekly' ? 'selected' : ''}>×©×‘×•×¢×™</option>
                        <option value="biweekly" ${student.frequency === 'biweekly' ? 'selected' : ''}>×“×•-×©×‘×•×¢×™</option>
                    </select>
                </td>
                <td><input type="number" value="${student.price || STUDENTS_DEFAULT_PRICE}" onchange="updateStudent(event, ${index}, 'price')"></td>
                <td><button onclick="deleteStudent(${index})">××—×§</button></td>
            `;
        });
    }

    function updateStudent(event, index, key) { /* (× ×©××¨ ×›×¤×™ ×©×”×™×”) */
        let value = event.target.value;
        if (key === 'price') {
            value = parseInt(value) || STUDENTS_DEFAULT_PRICE;
        }
        students[index][key] = value;
    }

    function deleteStudent(index) { /* (× ×©××¨ ×›×¤×™ ×©×”×™×”) */
        students.splice(index, 1);
        renderStudentsTable();
    }

    async function saveStudents() { /* (× ×©××¨ ×›×¤×™ ×©×”×™×”) */
        try {
            const response = await fetch('/api/students/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ students: students })
            });

            const result = await response.json();
            const messageElement = document.getElementById('studentMessage');
            
            if (response.ok) {
                messageElement.className = 'success';
                messageElement.innerHTML = `${result.message} (<a href="${result.commit_url}" target="_blank">×¦×¤×” ×‘-Commit</a>)`;
                loadStudents(); 
            } else {
                throw new Error(result.error || '×©×’×™××” ×‘×©××™×¨×” ×œ-GitHub.');
            }
        } catch (error) {
            console.error('Error saving students:', error);
            document.getElementById('studentMessage').className = 'error';
            document.getElementById('studentMessage').textContent = `×©×’×™××” ×‘×©××™×¨×”: ${error.message}`;
        }
    }

    // --- ×¤×•× ×§×¦×™×•×ª ×™×•××Ÿ ×•×ª×©×œ×•××™× ---

    async function loadCalendarEvents() {
        document.getElementById('eventMessage').textContent = '×˜×•×¢×Ÿ ××™×¨×•×¢×™ ×™×•××Ÿ...';
        document.getElementById('calendar-grid').innerHTML = ''; 
        document.getElementById('no-lessons-box').style.display = 'none';
        document.getElementById('paymentSummary').style.display = 'none';
        
        try {
            // ×§×¨×™××” ×œ×©×¨×ª ×¢× ×”×—×•×“×© ×•×”×©× ×” ×©× ×‘×—×¨×•
            const response = await fetch(`/api/calendar/events?month=${currentMonth}&year=${currentYear}`);
            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || '×©×’×™××” ×‘×©×œ×™×¤×ª ×™×•××Ÿ.');
            }
            
            renderCalendarGrid(result.events, result.startDate, result.endDate); 
            renderStudentsWithoutLessons(result.studentsWithoutLessons); 
            
            document.getElementById('eventMessage').className = 'success';
            document.getElementById('eventMessage').textContent = `âœ… × ×˜×¢× ×• ${result.events.length} ××™×¨×•×¢×™ ×™×•××Ÿ ×¢×‘×•×¨ ${document.getElementById('current-month-label').textContent}.`;
        } catch (error) {
            console.error('Error loading events:', error);
            document.getElementById('eventMessage').className = 'error';
            document.getElementById('eventMessage').textContent = `×©×’×™××” ×‘×˜×¢×™× ×ª ×™×•××Ÿ: ${error.message}. ×× × ×•×•×“× ×©×”×ª×—×‘×¨×ª ×œ×™×•××Ÿ ×‘×©×œ×‘ 1.`;
        }
    }

    // ×¤×•× ×§×¦×™×” ×œ×‘× ×™×™×ª ×ª×¦×•×’×ª ×œ×•×— ×”×©× ×” ×”××¨×•×‘×¢×ª (×¢×•×“×›×Ÿ ×œ×˜×™×¤×•×œ ×‘×—×•×“×© ×©×œ×)
    function renderCalendarGrid(events, startDateIso, endDateIso) {
        const calendarGrid = document.getElementById('calendar-grid');
        calendarGrid.innerHTML = '';
        const dayNames = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
        
        // ×™×¦×™×¨×ª ×›×•×ª×¨×•×ª ×”×™××™×
        dayNames.forEach(name => {
            const header = document.createElement('div');
            header.classList.add('day-header');
            header.textContent = name;
            calendarGrid.appendChild(header);
        });
        
        const startDate = new Date(startDateIso);
        const endDate = new Date(endDateIso);
        
        // 1. ×§×‘×™×¢×ª ××¡×¤×¨ ×™××™ ×¤×ª×™×—×” (Offset)
        // ×”-API ××—×–×™×¨ ×™×•× ×¨××©×•×Ÿ ×›-0, ×”-CSS ×©×œ× ×• ××ª×—×™×œ ×‘×™×•× ×¨××©×•×Ÿ
        const startDayOfWeek = startDate.getDay(); 
        
        // ×”×•×¡×¤×ª ×ª××™ ×¨×™×§×™× ×œ×¤× ×™ ×ª×—×™×œ×ª ×”×—×•×“×© (×›×“×™ ×œ×”×ª××™× ×œ×™×•× ×‘×©×‘×•×¢)
        for (let i = 0; i < startDayOfWeek; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.classList.add('day-cell');
            emptyCell.style.backgroundColor = '#f4f4f4'; 
            emptyCell.style.border = '1px dashed #ccc';
            calendarGrid.appendChild(emptyCell);
        }

        // 2. ×™×¦×™×¨×ª ××¤×ª ××™×¨×•×¢×™× ×œ×’×™×©×” ××”×™×¨×”
        const eventsByDate = events.reduce((map, event) => {
            const dateKey = event.start.dateTime.split('T')[0];
            if (!map[dateKey]) map[dateKey] = [];
            map[dateKey].push(event);
            return map;
        }, {});


        // 3. ×‘× ×™×™×ª ×¨×™×‘×•×¢×™ ×”×—×•×“×©
        let date = new Date(startDate);
        while (date <= endDate) {
            const dateKey = date.toISOString().split('T')[0];
            
            const cell = document.createElement('div');
            cell.classList.add('day-cell');
            
            // ×ª××¨×™×š
            const dateHeader = document.createElement('span');
            dateHeader.classList.add('date-label');
            dateHeader.textContent = date.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit' });
            cell.appendChild(dateHeader);
            
            const dayEvents = eventsByDate[dateKey] || [];
            
            // ××™×•×Ÿ ×”××™×¨×•×¢×™× ×œ×¤×™ ×©×¢×”
            dayEvents.sort((a, b) => new Date(a.start.dateTime) - new Date(b.start.dateTime));

            // ×”×•×¡×¤×ª ×”×©×™×¢×•×¨×™× ×œ×¨×™×‘×•×¢
            dayEvents.forEach(event => {
                const lessonEntry = document.createElement('div');
                lessonEntry.classList.add('lesson-entry');
                
                const eventStart = new Date(event.start.dateTime);
                const time = eventStart.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
                
                lessonEntry.innerHTML = `<strong>${time}</strong> ${event.summary.trim()}`;
                
                // ×¡×˜×˜×•×¡ ×ª×©×œ×•×
                const status = event.paymentStatus || '×œ× ×‘×•×¦×¢ ×¢×“×™×™×Ÿ';
                if (status === '×©×•×œ×') {
                    lessonEntry.classList.add('paid');
                } else if (status === '×œ× ×©×•×œ×') {
                    lessonEntry.classList.add('unpaid');
                } else if (status === '×××ª×™×Ÿ') {
                    lessonEntry.classList.add('pending');
                }

                lessonEntry.onclick = () => openPaymentModal(event);
                cell.appendChild(lessonEntry);
            });
            
            calendarGrid.appendChild(cell);
            
            // ×¢×•×‘×¨×™× ×œ×™×•× ×”×‘×
            date.setDate(date.getDate() + 1);
        }
        
        renderPaymentSummary(events, startDateIso);
    }
    
    // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×ª×œ××™×“×™× ×©×œ× ×§×‘×¢×• ×©×™×¢×•×¨ (×¢×•×“×›×Ÿ ×œ×›×•×ª×¨×ª ×—×•×“×©×™×ª)
    function renderStudentsWithoutLessons(studentsList) { /* (× ×©××¨ ×›×¤×™ ×©×”×™×”) */
        const noLessonsBox = document.getElementById('no-lessons-box');
        const noLessonsList = document.getElementById('no-lessons-list');
        noLessonsList.innerHTML = '';
        
        if (studentsList && studentsList.length > 0) {
            noLessonsBox.style.display = 'block';
            studentsList.forEach(name => {
                const li = document.createElement('li');
                li.textContent = name;
                noLessonsList.appendChild(li);
            });
        } else {
            noLessonsBox.style.display = 'none';
        }
    }

    // --- ×¤×•× ×§×¦×™×•×ª ××•×“××œ ×•×ª×©×œ×•× ---

    function openPaymentModal(event) { /* (× ×©××¨ ×›×¤×™ ×©×”×™×”) */
        currentLessonKey = event.lessonKey;
        document.getElementById('modalLessonName').textContent = `×©×™×¢×•×¨: ${event.summary}`;
        document.getElementById('paymentStatusSelect').value = event.paymentStatus || '×œ× ×‘×•×¦×¢ ×¢×“×™×™×Ÿ';
        document.getElementById('paymentModal').style.display = 'flex';
    }

    function closePaymentModal() { /* (× ×©××¨ ×›×¤×™ ×©×”×™×”) */
        document.getElementById('paymentModal').style.display = 'none';
        currentLessonKey = null;
    }
    
    async function savePaymentStatus() { /* (× ×©××¨ ×›×¤×™ ×©×”×™×”) */
        const status = document.getElementById('paymentStatusSelect').value;
        
        try {
            const response = await fetch('/api/payments/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lessonKey: currentLessonKey, status: status })
            });

            if (response.ok) {
                alert('×¡×˜×˜×•×¡ ×ª×©×œ×•× × ×©××¨ ×‘×”×¦×œ×—×”!');
                closePaymentModal();
                loadCalendarEvents(); // ×˜×¢×Ÿ ××—×“×© ××ª ×”× ×ª×•× ×™× ×›×“×™ ×œ×¢×“×›×Ÿ ××ª ×œ×•×— ×”×©× ×” ×•×”×¡×™×›×•×
            } else {
                const data = await response.json();
                alert('×©×’×™××” ×‘×©××™×¨×ª ×ª×©×œ×•×: ' + (data.error || '×©×’×™××” ×œ× ×™×“×•×¢×”'));
            }
        } catch (error) {
            alert('×©×’×™××ª ×¨×©×ª ××• ×©×¨×ª ×‘×©××™×¨×ª ×ª×©×œ×•×.');
        }
    }

    function getStartOfWeek(date) {
        const d = new Date(date);
        // ×™×•× ×¨××©×•×Ÿ (0) ×”×•× ×ª×—×™×œ×ª ×”×©×‘×•×¢ 
        const day = d.getDay(); 
        const diff = d.getDate() - day;
        const startOfWeek = new Date(d.setDate(diff));
        startOfWeek.setHours(0, 0, 0, 0);
        return startOfWeek.toISOString().split('T')[0];
    }

    // ×¤×•× ×§×¦×™×” ×œ×—×™×©×•×‘ ×•×™×™×¦×•×’ ×¡×™×›×•× ×”×ª×©×œ×•××™× (×¢×•×“×›×Ÿ ×œ×¡×™×›×•× ×—×•×“×©×™)
    function renderPaymentSummary(events) {
        const summaryBox = document.getElementById('paymentSummary');
        const paymentSummary = {};
        let totalMonthlyIncome = 0; // ×¡×™×›×•× ×›×œ×œ×™ ×œ×—×•×“×©

        events.forEach(event => {
            const status = event.paymentStatus || '×œ× ×‘×•×¦×¢ ×¢×“×™×™×Ÿ';
            // ×¡×•×¤×¨×™× ×¨×§ ×©×™×¢×•×¨×™× ×©×©×•×œ××•
            if (status !== '×©×•×œ×') return; 

            // 1. ××¦×™××ª ×©× ×”×ª×œ××™×“ ×•×”××—×™×¨ ×©×œ×• 
            const eventSummaryLower = event.summary.trim().toLowerCase();
            let lessonPrice = STUDENTS_DEFAULT_PRICE;

            for (const cleanName in studentsMap) {
                if (eventSummaryLower.includes(cleanName)) {
                    lessonPrice = studentsMap[cleanName].price;
                    break;
                }
            }
            
            // 2. ×—×™×©×•×‘ ×©×‘×•×¢ ×•×¦×‘×™×¨×ª ×¡×›×•××™×
            const eventStart = new Date(event.start.dateTime || event.start.date);
            const weekStartDate = getStartOfWeek(eventStart);
            
            if (!paymentSummary[weekStartDate]) {
                paymentSummary[weekStartDate] = { received: 0, startDate: eventStart };
            }
            
            paymentSummary[weekStartDate].received += lessonPrice;
            totalMonthlyIncome += lessonPrice; // ×¦×‘×™×¨×” ×œ×¡×™×›×•× ×”×—×•×“×©×™
        });

        let html = '<h3>×¡×™×›×•× ×ª×©×œ×•××™× ×©×”×ª×§×‘×œ×•</h3>';
        
        // ××™×•×Ÿ ×œ×¤×™ ×ª××¨×™×š ×”×ª×—×œ×”
        const sortedWeeks = Object.keys(paymentSummary).sort();

        // ×¡×™×›×•× ×©×‘×•×¢×™
        sortedWeeks.forEach(weekStartIso => {
            const weekData = paymentSummary[weekStartIso];

            const startOfWeek = new Date(weekStartIso);
            const endOfWeek = new Date(startOfWeek.getTime() + 6 * 24 * 60 * 60 * 1000); 

            const formattedStart = startOfWeek.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit' });
            const formattedEnd = endOfWeek.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit' });

            html += `
                <p><strong>â‚ª${weekData.received}</strong> - ×¡×”"×› ×ª×©×œ×•× ×©×”×ª×§×‘×œ ×œ×©×‘×•×¢ ${formattedStart} - ${formattedEnd}</p>
            `;
        });
        
        // ×¡×™×›×•× ×—×•×“×©×™ ×›×œ×œ×™
        if (totalMonthlyIncome > 0) {
             html += `<hr style="margin: 10px 0;">`;
             html += `<p style="font-size: 1.3em; font-weight: bold; color: #0056b3;">ğŸ’° ×¡×”"×› ×”×›× ×¡×•×ª ×—×•×“×©×™×•×ª (×ª×©×œ×•××™× ×©××•×©×¨×•): â‚ª${totalMonthlyIncome}</p>`;
        }


        summaryBox.innerHTML = html;
        summaryBox.style.display = (sortedWeeks.length > 0 || totalMonthlyIncome > 0) ? 'block' : 'none';
    }
</script>

</body>
</html>
